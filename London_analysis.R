# Load required packages
library(data.table)
library(reshape2)
# Source custom functions
source("date_functions.R")

# Read in cleaned data files
period <- data.table(read.csv("period-CLEANED.csv"))
setkey(period, Site_P)
context <- data.table(read.csv("context-CLEANED.csv"))
setkey(context, SITE_C)
sample <- data.table(read.csv("sample-CLEANED.csv"))
setkey(sample, SITE_S)
Fish <- data.table(read.csv("Fish-CLEANED.csv"))
setkey(period, Site_P)

# Link tables together; drop un-needed fields
context.period <- merge(period[,list(Site_P,Start,End,MID)], context[,list(SITE_C,Site_P)], "Site_P", all=FALSE)
sample.period <- merge(context.period, sample[,list(SITE_S, SITE_C)], "SITE_C", all=FALSE)
fish.period <- merge(period[,list(Site_P,Start,End,MID)], Fish[,list(SITE_C,Frag,Site_P)], "Site_P", all=FALSE)

# Plot histogram of context mid-points
# justifies concentration on last 2000 years
hist(context.period$MID, seq(-10000, 2000, 100))

# Calculate distribution of CONTEXTS across time
# First remove unecessary data to clear RAM
rm(context)
rm(period)
rm(sample)
# a) using aoristic sum method (should take 15-20 minutes with default arguments)
x <- aorist(context.period[, list(Start,End)])
barplot(x, names.arg=breaks[1:(length(breaks)-1)])
write.csv(x, "contexts_aoristic_sum_by_period.csv", row.names=FALSE)

# b) using simulation method (should take 3-5 minutes with default arguments)
set.seed(1901)
y <- date.simulate(context.period[, list(Start,End)], rep=500)
write.csv(y, "contexts_simulated_by_period.csv", row.names=FALSE)
boxplot(V1 ~ bin, data=y)
z <- y[,quantile(V1, probs=c(0.05,0.25,0.5,0.75,0.95)), by=bin]
z[,id:=c(0.05,0.25,0.5,0.75,0.95)]
z <- dcast.data.table(z, bin ~ id, value.var="V1")
write.csv(z, "summary_context_sim_by_period.csv", row.names=FALSE)


# Calculate distribution of SAMPLES across time
# a) using aoristic sum method (should take 15-20 minutes with default arguments)
x <- aorist(sample.period[, list(Start,End)])
barplot(x, names.arg=breaks[1:(length(breaks)-1)])
write.csv(x, "samples_aoristic_sum_by_period.csv", row.names=FALSE)

# b) using simulation method (should take 3-5 minutes with default arguments)
set.seed(1982)
y <- date.simulate(sample.period[, list(Start,End)], rep=500)
write.csv(y, "samples_simulated_by_period.csv", row.names=FALSE)
boxplot(V1 ~ bin, data=y)
z <- y[,quantile(V1, probs=c(0.05,0.25,0.5,0.75,0.95)), by=bin]
z[,id:=c(0.05,0.25,0.5,0.75,0.95)]
z <- dcast.data.table(z, bin ~ id, value.var="V1")
write.csv(z, "summary_sample_sim_by_period.csv", row.names=FALSE)

# Calculate distribution of FISH across time
# using simulation method (should take 3-5 minutes with default arguments)
set.seed(1901)
w <- date.simulate(fish.period[, list(Start,End)], weight=Fish.period[,Frag], rep=500)
write.csv(w, "fish_simulated_by_period.csv", row.names=FALSE)
boxplot(V1 ~ bin, data=w)
v <- w[,quantile(V1, probs=c(0.05,0.25,0.5,0.75,0.95)), by=bin]
v[,id:=c(0.05,0.25,0.5,0.75,0.95)]
v <- dcast.data.table(z, bin ~ id, value.var="V1")
write.csv(v, "summary_fish_sim_by_period.csv", row.names=FALSE)
